{% extends 'base.html' %}

{% load custom_filters %}

{% block title %}Post by {{ post.user.username }} - Ani Posts{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-8">
    <!-- Back Navigation -->
    <div class="mb-6">
        <a href="{% url 'home' %}" class="inline-flex items-center space-x-2 text-gray-400 hover:text-white transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            <span>Back to Posts</span>
        </a>
    </div>

    <!-- Main Post Section -->
    <article class="bg-gray-900 border border-gray-700 rounded-xl p-6 shadow-lg mb-6">
        <!-- Post Header -->
        <div class="flex items-start justify-between mb-4">
            <div class="flex items-center space-x-3">
                <!-- User Avatar -->
                <img src="{{ post.avatar_url }}"
                     alt="{{ post.user.username }}"
                     class="w-12 h-12 rounded-full border-2 border-gray-600 object-cover">

                <!-- User Info -->
                <div>
                    <h3 class="font-semibold text-white text-lg hover:text-purple-400 cursor-pointer transition-colors">
                        {{ post.user.username }}
                    </h3>
                    <p class="text-sm text-gray-400">@{{ post.user.username }}</p>
                </div>
            </div>

            <!-- Post Menu -->
            <div class="relative inline-block text-left">
                <button onclick="toggleMenu(this)"
                    class="text-gray-400 hover:text-white p-2 rounded-full hover:bg-gray-800 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path>
                    </svg>
                </button>

                {% if post.user == request.user or request.user.is_superuser%}
                <!-- Dropdown -->
                <div class="hidden absolute right-0 w-32 rounded-lg shadow-lg bg-gray-800 border border-gray-700 z-10">
                    <form method="POST" action="{% url 'delete_post' post.id %}">
                        {% csrf_token %}
                        <button type="submit"
                            onclick="return confirm('Are you sure you want to delete this post?');"
                            class="block w-full text-left text-red-400 hover:bg-gray-700 rounded-lg px-4 py-2">
                            Delete Post
                        </button>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Post Content -->
        <div class="mb-4">
            <p class="text-gray-200 text-lg leading-relaxed whitespace-pre-wrap">{{ post.content }}</p>
        </div>

        <!-- Timestamp -->
        <div class="flex items-center space-x-2 text-sm text-gray-400 mb-4">
            <time datetime="{{ post.created_at|date:'c' }}">
                {{ post.created_at|date:"g:i A Â· M j, Y" }}
            </time>
        </div>

        <!-- Post Stats -->
        <div class="border-t border-b border-gray-700 py-3 mb-3">
            <div class="flex items-center justify-around">
                <button class="flex items-center space-x-1 text-gray-400 hover:text-white transition-colors">
                    <span class="like-count font-semibold text-white">{{ post.likes_count|default:"0" }}</span>
                    <span>Likes</span>
                </button>
                <button class="flex items-center space-x-1 text-gray-400 hover:text-white transition-colors">
                    <span class="font-semibold text-white">{{ post.comments.count }}</span>
                    <span>Comments</span>
                </button>
                <button class="flex items-center space-x-1 text-gray-400 hover:text-white transition-colors">
                    <span class="font-semibold text-white">{{ post.shares_count|default:"0" }}</span>
                    <span>Shares</span>
                </button>
            </div>
        </div>

        <!-- Post Actions -->
        <div class="flex items-center justify-around">
            <!-- Like Button -->
            <button data-post-id="{{ post.id }}"
                    class="like-btn flex items-center space-x-2 text-gray-400 hover:text-red-400 transition-colors group px-4 py-2 rounded-lg hover:bg-gray-800 {% if user_has_liked %}text-red-500{% endif %}">
                <svg class="w-5 h-5 group-hover:scale-110 transition-transform"
                     fill="{% if user_has_liked %}currentColor{% else %}none{% endif %}"
                     stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                </svg>
            </button>

            <!-- Comment Button (scrolls to comment form) -->
            <button onclick="document.getElementById('comment-form').scrollIntoView({ behavior: 'smooth' })"
                    class="flex items-center space-x-2 text-gray-400 hover:text-blue-400 transition-colors group px-4 py-2 rounded-lg hover:bg-gray-800">
                <svg class="w-5 h-5 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                </svg>
            </button>

            <!-- Share Button -->
            <button class="flex items-center space-x-2 text-gray-400 hover:text-green-400 transition-colors group px-4 py-2 rounded-lg hover:bg-gray-800">
                <svg class="w-5 h-5 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
                </svg>
            </button>
        </div>
    </article>

    <!-- Comment Form -->
    <div id="comment-form" class="bg-gray-900 border border-gray-700 rounded-xl p-6 shadow-lg mb-6">
        <h3 class="text-lg font-semibold text-white mb-4">Add a comment</h3>
        <form method="POST" action="{% url 'add_comment' post.id %}" class="space-y-4">
            {% csrf_token %}
            <div class="flex items-start space-x-3">
                <!-- Current User Avatar -->
                <div class="flex-shrink-0">
                    <img src="{{ user_img }}"
                         class="w-10 h-10 rounded-full border-2 border-gray-600 object-cover"
                         alt="{{ request.user.username }}">
                </div>
                <!-- Comment Input -->
                <div class="flex-1">
                    <textarea
                        name="content"
                        id="comment-content"
                        placeholder="Write your comment..."
                        class="w-full bg-gray-800 border border-gray-600 rounded-lg p-3 text-white placeholder-gray-400 resize-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200 min-h-[80px]"
                        maxlength="280"
                        required
                    ></textarea>
                    <div class="flex items-center justify-between mt-3">
                        <span id="comment-char-count" class="text-xs text-gray-400">0/280</span>
                        <button
                            type="submit"
                            id="comment-button"
                            class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-semibold px-5 py-2 rounded-lg transition-all duration-200 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none text-sm"
                            disabled
                        >
                            Reply
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Comments Section -->
    <section class="space-y-4">
        <!-- Section Header -->
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold text-white">Comments ({{ post.comments.count }})</h2>
            <!-- Sort Options -->
            <select class="bg-gray-800 border border-gray-600 rounded-lg px-3 py-1.5 text-sm text-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                <option value="newest">Newest First</option>
                <option value="oldest">Oldest First</option>
                <option value="popular">Most Popular</option>
            </select>
        </div>

        <!-- Comments List -->
        {% if post.comments.all %}
            {% for comment in post.comments.all %}
            <div class="bg-gray-900 border border-gray-700 rounded-xl p-4 shadow-lg hover:border-gray-600 transition-colors duration-200">
                <!-- Comment Header -->
                <div class="flex items-start justify-between mb-3">
                    <div class="flex items-center space-x-3">
                        <!-- Commenter Avatar -->
                        <img src="{{ comment.avatar_url }}"
                             alt="{{ comment.user.username }}"
                             class="w-9 h-9 rounded-full border-2 border-gray-600 object-cover">

                        <!-- Commenter Info -->
                        <div>
                            <div class="flex items-center space-x-2">
                                <h4 class="font-semibold text-white text-sm hover:text-purple-400 cursor-pointer transition-colors">
                                    {{ comment.user.username }}
                                </h4>
                                <span class="text-gray-500 text-xs">Â·</span>
                                <time class="text-xs text-gray-400" datetime="{{ comment.created_at|date:'c' }}">
                                    {{ comment.created_at|custom_time_display }}
                                </time>
                            </div>
                        </div>
                    </div>

                    <!-- Comment Menu -->
                    {% if comment.user == request.user %}
                    <div class="relative inline-block text-left">
                        <button onclick="toggleMenu(this)"
                            class="text-gray-400 hover:text-white p-1 rounded-full hover:bg-gray-800 transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path>
                            </svg>
                        </button>

                        <!-- Dropdown -->
                        <div class="hidden absolute right-0 w-28 rounded-lg shadow-lg bg-gray-800 border border-gray-700 z-10">
                            <form method="POST" action="{% url 'delete_comment' comment.id %}">
                                {% csrf_token %}
                                <button type="submit"
                                    onclick="return confirm('Are you sure you want to delete this comment?');"
                                    class="block w-full text-left text-red-400 hover:bg-gray-700 rounded-lg px-4 py-2 text-sm">
                                    Delete
                                </button>
                            </form>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Comment Content -->
                <div class="pl-12">
                    <p class="text-gray-200 text-sm leading-relaxed whitespace-pre-wrap">{{ comment.content }}</p>

                    <!-- Comment Actions -->
                    <div class="flex items-center space-x-4 mt-3">
                        <button class="flex items-center space-x-1 text-gray-400 hover:text-red-400 transition-colors text-xs group">
                            <svg class="w-4 h-4 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                            </svg>
                            <span>{{ comment.likes_count|default:"0" }}</span>
                        </button>

                        <button onclick="replyToComment('{{ comment.user.username }}')"
                                class="text-gray-400 hover:text-blue-400 transition-colors text-xs">
                            Reply
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <!-- No Comments State -->
            <div class="text-center py-0">
                <div class="bg-gray-900 border border-gray-700 rounded-xl p-8">
                    <div class="w-14 h-14 bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-7 h-7 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-300 mb-2">No comments yet</h3>
                    <p class="text-gray-400 mb-4">Be the first to share your thoughts!</p>
                    <button onclick="document.getElementById('comment-form').scrollIntoView({ behavior: 'smooth' })"
                            class="text-purple-400 hover:text-purple-300 font-medium text-sm">
                        Write a comment
                    </button>
                </div>
            </div>
        {% endif %}
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Character counter for comment
    document.addEventListener("DOMContentLoaded", function () {
        const commentTextarea = document.getElementById("comment-content");
        const commentCharCount = document.getElementById("comment-char-count");
        const commentButton = document.getElementById("comment-button");
        const maxChars = 280;

        commentTextarea.addEventListener("input", function () {
            const currentLength = commentTextarea.value.trim().length;
            commentCharCount.textContent = `${currentLength}/${maxChars}`;

            // Change color when close to limit
            if (currentLength > maxChars - 20) {
                commentCharCount.classList.remove("text-gray-400");
                commentCharCount.classList.add("text-red-400");
            } else {
                commentCharCount.classList.remove("text-red-400");
                commentCharCount.classList.add("text-gray-400");
            }

            // Enable/disable comment button
            commentButton.disabled = currentLength === 0 || currentLength > maxChars;
        });
    });

    // Toggle dropdown menu
    function toggleMenu(button) {
        // Close all open menus
        document.querySelectorAll('.relative .absolute').forEach(menu => {
            if (menu !== button.parentElement.querySelector('.absolute')) {
                menu.classList.add('hidden');
            }
        });

        // Toggle the menu for the clicked button
        const menu = button.parentElement.querySelector('.absolute');
        if (menu) {
            menu.classList.toggle('hidden');
        }
    }

    // Close dropdown if clicked outside
    document.addEventListener('click', function(event) {
        if (!event.target.closest('.relative')) {
            document.querySelectorAll('.relative .absolute').forEach(menu => {
                menu.classList.add('hidden');
            });
        }
    });

    // Reply to comment function
    function replyToComment(username) {
        const commentTextarea = document.getElementById("comment-content");
        const character_count = document.getElementById("comment-char-count");
        let mention_username = `@` + username;
        character_count.innerHTML = mention_username.length + `/280`;
        commentTextarea.value = mention_username + ` `;
        commentTextarea.focus();
        document.getElementById('comment-form').scrollIntoView({ behavior: 'smooth' });
    }

    // Like post functionality (AJAX)
    document.querySelectorAll('.like-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const postId = this.dataset.postId;
            const icon = this.querySelector('svg');

            // Toggle visual state immediately for better UX
            if (icon.getAttribute('fill') === 'none') {
                icon.setAttribute('fill', 'currentColor');
                this.classList.add('text-red-500');
            } else {
                icon.setAttribute('fill', 'none');
                this.classList.remove('text-red-500');
            }

            // Send AJAX request to toggle like
            fetch(`/post/${postId}/like/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                // Update like count if returned from server
                if (data.likes_count !== undefined) {
                    // Update the likes count display
                    document.querySelector('.like-count').textContent = data.likes_count;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Revert visual state on error
                if (icon.getAttribute('fill') === 'currentColor') {
                    icon.setAttribute('fill', 'none');
                    this.classList.remove('text-red-500');
                } else {
                    icon.setAttribute('fill', 'currentColor');
                    this.classList.add('text-red-500');
                }
            });
        });
    });
</script>
{% endblock %}