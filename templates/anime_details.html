{% extends 'base.html' %}

{% load status_colors %}

{% block content %}

<div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header Section -->
        <div class="flex flex-col lg:flex-row gap-8 mb-8">
            <!-- Left Column - Poster and Buttons -->
            <div class="lg:w-1/3 xl:w-1/4">
                <!-- Anime Poster -->
                <div class="relative group mb-6">
                    <div class="relative overflow-hidden rounded-2xl shadow-2xl transform transition-all duration-300">
                        <img src="{{ anime.images.webp.large_image_url }}"
                             alt="{{ anime.title }}"
                             class="w-full h-auto aspect-[3/4] object-cover">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                    </div>
                    <!-- Score Badge -->
                    {% if anime.score %}
                    <div class="absolute top-4 right-4 bg-gradient-to-r from-anime-purple to-anime-pink px-3 py-2 rounded-full flex items-center space-x-1 shadow-lg">
                        <i class="fas fa-star text-yellow-400 text-sm"></i>
                        <span class="text-white font-bold text-sm">{{ anime.score }}</span>
                    </div>
                    {% endif %}
                    <div class="absolute top-4 left-6">
                            <!-- Heart Button -->
                            <button
                                class="cursor-pointer bg-transparent hover:scale-110 transition-transform duration-200"
                                onclick="toggleFavorite({{ anime.mal_id }})"
                                aria-label="Favorite">
                                <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1 {% if is_fav %} fill-pink-500 stroke-pink-500 {% endif %}" id="fav-icon">
                                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                                </svg>
                              </button>
                    </div>

                </div>

                <!-- Action Buttons -->
                <div class="space-y-3">
                    <button class="w-full bg-gray-800  text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl flex items-center justify-center space-x-2" onclick="AddToWatchList({{ malId }})" {% if is_added %}disabled{% endif %}>
                        {% if is_added %}
                        <span>Added</span>
                        <i class="fas fa-check"></i>
                        {% else %}
                        <i class="fas fa-plus"></i>
                        <span>Add to Watchlist</span>
                        {% endif %}
                    </button>

                    <a href="{{ trailer_url|default:'' }}" target="_blank" rel="noopener noreferrer"
                       class="w-full bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-600 hover:to-pink-700 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl flex items-center justify-center space-x-2">
                        <i class="fas fa-play"></i>
                        <span>Watch Trailer</span>
                    </a>
                </div>
            </div>

            <!-- Right Column - Main Content -->
            <div class="lg:w-2/3 xl:w-3/4">
                <!-- Title Section -->
                <div class="mb-6">
                    <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold mb-4 ">
                        {{ anime.title_english }}
                    </h1>

                    <!-- Alternative Titles -->
                    {% if anime.title %}
                    <p class="text-xl text-gray-300 mb-2">{{ anime.title }}</p>
                    {% endif %}
                    {% if anime.title_japanese %}
                    <p class="text-lg text-gray-400 mb-4">{{ anime.title_japanese }}</p>
                    {% endif %}

                    <!-- Info Tags -->
                    <div class="flex flex-wrap items-center gap-3 mb-6">
                        <!-- Status Badge -->
                        {% if anime.status %}
                        <span class="px-4 py-2 rounded-full text-sm font-semibold
                            {% if anime.status == 'Finished Airing' or anime.status == 'Completed' %}
                                bg-green-500/20 text-green-400 border border-green-500/30
                            {% elif anime.status == 'Currently Airing' %}
                                bg-blue-500/20 text-blue-400 border border-blue-500/30
                            {% else %}
                                bg-gray-500/20 text-gray-400 border border-gray-500/30
                            {% endif %}">
                            {{ anime.status }}
                        </span>
                        {% endif %}

                        <!-- Year -->
                        {% if anime.year %}
                        <span class="px-3 py-1 bg-anime-darker rounded-lg text-sm text-gray-300 border border-gray-700">
                            {{ anime.aired.prop.from.year }}
                        </span>
                        {% endif %}

                        <!-- Duration -->
                        {% if anime.duration %}
                        <span class="px-3 py-1 bg-anime-darker rounded-lg text-sm text-gray-300 border border-gray-700">
                            <i class="fas fa-clock mr-1"></i>{{ anime.duration }}
                        </span>
                        {% endif %}

                        <!-- Episodes -->
                        {% if anime.episodes %}
                        <span class="px-3 py-1 bg-anime-darker rounded-lg text-sm text-gray-300 border border-gray-700">
                            <i class="fas fa-film mr-1"></i>{{ anime.episodes }} eps
                        </span>
                        {% endif %}
                    </div>
                </div>

                <!-- Synopsis Section -->
                <div class="mb-8">
                    <h2 class="text-2xl font-bold mb-4 text-anime-purple">Synopsis</h2>
                    <div class="rounded-xl p-3 border border-gray-800 max-h-60 overflow-x-auto scrollbar-custom">
                        <p class="text-gray-300 leading-relaxed">
                            {{ anime.synopsis|default:"No synopsis available." }}
                        </p>
                    </div>
                </div>

                <!-- Details Section -->
                <div class="grid md:grid-cols-2 gap-6 mb-8">
                    <!-- Genres -->
                    <div>
                        <h3 class="text-xl font-semibold mb-3 text-anime-pink">Genres</h3>
                        <div class="flex flex-wrap gap-2">
                            {% for genre in anime.genres %}
                            <span class="px-3 py-1 bg-gradient-to-r from-anime-purple/20 to-anime-pink/20 border border-anime-purple/30 rounded-full text-sm text-gray-300 hover:from-anime-purple/30 hover:to-anime-pink/30 transition-colors duration-200">
                                {{ genre.name }}
                            </span>
                            {% empty %}
                            <span class="text-gray-500">No genres available</span>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Studio -->
                    <div>
                        <h3 class="text-xl font-semibold mb-3 text-anime-pink">Studio</h3>
                        <div>
                            {% for studio in anime.studios %}
                            <span class="inline-block px-4 py-2 bg-anime-darker border border-gray-700 rounded-lg text-gray-300">
                                {{ studio.name }}
                            </span>
                            {% empty %}
                            <span class="text-gray-500">Unknown Studio</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Characters Section -->
        {% if anime_characters %}
        <div class="mb-8">
            <h2 class="text-3xl font-bold mb-6 text-anime-purple">Main Characters</h2>
            <div class="relative">
                <div class="flex space-x-6 overflow-x-auto pb-4 scrollbar-custom">
                    {% for character in anime_characters %}
                    <div class="flex-shrink-0 w-32 text-center group">
                        <div class="relative mb-3">
                            <div class="w-24 h-24 mx-auto rounded-full overflow-hidden border-4 border-transparent bg-gradient-to-r from-anime-purple to-anime-pink p-1 group-hover:scale-110 transition-transform duration-300">
                                <img src="{{ character.character.images.jpg.image_url }}"
                                     alt="{{ character.character.name }}"
                                     class="w-full h-full object-cover rounded-full bg-anime-darker">
                            </div>
                        </div>
                        <h4 class="text-sm font-semibold text-gray-300 group-hover:text-white transition-colors duration-200 leading-tight">
                            {{ character.character.name }}
                        </h4>
                        <p class="text-xs text-gray-500 mt-1">{{ character.role }}</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
{% endblock %}
{% block scripts %}
    <script>
           function AddToWatchList(malId) {
                const button = document.querySelector('button[onclick^="AddToWatchList"]');
                button.innerHTML = '<span>Added</span><i class="fas fa-check"></i>';
                fetch('/add-to-watchlist/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: `mal_id=${malId}`
                })
                .then(response => response.json().then(data => ({ data, status: response.status })))
                .then(({ data, status }) => {
                    if (status === 201) {
                        button.disabled = true;
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    button.innerHTML = '<i class="fas fa-plus"></i><span>Add to Watchlist</span>';
                    console.error('Error adding to watchlist:', error);
                });
            }
    </script>
{% endblock %}