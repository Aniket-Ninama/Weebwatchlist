{% extends 'base.html' %}

{% load status_colors %}

{% block content %}

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header Section -->
        <div class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-bold mb-4" style="color: #7c3aed;">
                Explore Anime
            </h1>
            <p class="text-xl text-gray-400 max-w-2xl mx-auto">
                Discover your next favorite anime from thousands of titles.
            </p>
        </div>

        <!-- Search Section -->
        <div class="bg-gray-900 border border-gray-700 rounded-xl p-6 mb-8 shadow-lg">
            <form method="get" action="{% url 'explore' %}" class="space-y-6" id="animesearch-form">
                <!-- Search Bar -->
                <div class="flex flex-col sm:flex-row gap-4 sm:items-center sm:justify-between">
                    <div class="flex-1 relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        <input
                            type="text"
                            name="search"
                            id="search"
                            value=""
                            placeholder="Search anime titles"
                            class="w-full bg-gray-800 border border-gray-600 rounded-lg pl-10 pr-4 py-3 text-white placeholder-gray-400 focus:ring-2 focus:ring-purple-primary focus:border-transparent transition-all duration-200">
                    </div>
                    <button
                        type="submit"
                        class="hide-under-640 px-8 py-3 font-semibold text-white rounded-lg transition-all duration-200 transform hover:scale-105 focus:ring-2 focus:ring-purple-primary focus:ring-offset-2 focus:ring-offset-gray-900 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 sm:order-none order-last">
                        Search
                    </button>
                </div>

                <!-- Filter Buttons -->
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mt-4">
                    <!-- Genre Filter -->
                    <div class="relative">
                        <button
                            type="button"
                            onclick="toggleDropdown('genre-dropdown')"
                            class="w-full bg-gray-800 hover:bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-left flex items-center justify-between transition-colors duration-200">
                            <div class="flex items-center space-x-2">
                                <svg class="w-5 h-5 text-purple-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                                </svg>
                                <span class="dropdown-label" data-default="Genre">Genre</span>
                            </div>
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div id="genre-dropdown" class="dropdown hidden absolute top-full left-0 right-0 mt-1 bg-gray-800 border border-gray-600 rounded-lg shadow-xl z-10 max-h-48 overflow-y-auto scrollbar-custom">
                            <div class="p-2 space-y-1 scrollbar-hide">
                                {% for genre in genres %}
                                <label class=" flex items-center space-x-2 p-2 hover:bg-gray-700 rounded cursor-pointer scrollbar-hide">
                                    <input type="radio" name="genre" value="{{ genre|lower }}" class="appearance-none text-purple-primary hover:text-500-gray">
                                    <span>{{ genre }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- Year Filter -->
                    <div class="relative">
                        <button
                            type="button"
                            onclick="toggleDropdown('year-dropdown')"
                            class="w-full bg-gray-800 hover:bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-left flex items-center justify-between transition-colors duration-200">
                            <div class="flex items-center space-x-2">
                                <svg class="w-5 h-5 text-purple-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                                <span class="dropdown-label" data-default="Year">Year</span>
                            </div>
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div id="year-dropdown" class="dropdown hidden absolute top-full left-0 right-0 mt-1 bg-gray-800 border border-gray-600 rounded-lg shadow-xl z-10 max-h-48 overflow-y-auto scrollbar-custom">
                            <div class="p-2 space-y-1">
                                {% for year in years %}
                                <label class="flex items-center space-x-2 p-2 hover:bg-gray-700 rounded cursor-pointer">
                                    <input type="radio" name="year" value="{{ year }}" class="appearance-none text-purple-primary hover:text-500-gray">
                                    <span>{{ year }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- Rating Filter -->
                    <div class="relative">
                        <button
                            type="button"
                            onclick="toggleDropdown('rating-dropdown')"
                            class="w-full bg-gray-800 hover:bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-left flex items-center justify-between transition-colors duration-200">
                            <div class="flex items-center space-x-2">
                                <svg class="w-5 h-5 text-purple-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                                </svg>
                                <span class="dropdown-label" data-default="Rating">Rating</span>
                            </div>
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div id="rating-dropdown" class="dropdown hidden absolute top-full left-0 right-0 mt-1 bg-gray-800 border border-gray-600 rounded-lg shadow-xl z-10 max-h-48 overflow-y-auto scrollbar-custom">
                            <div class="p-2 space-y-1">
                                {% for rating in ratings %}
                                <label class="flex items-center space-x-2 p-2 hover:bg-gray-700 rounded cursor-pointer">
                                    <input type="radio" name="rating" value="{{ rating }}" class="appearance-none text-purple-primary hover:text-500-gray">
                                    <span>{{ rating }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- Status Filter -->
                    <div class="relative">
                        <button
                            type="button"
                            onclick="toggleDropdown('status-dropdown')"
                            class="w-full bg-gray-800 hover:bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-left flex items-center justify-between transition-colors duration-200">
                            <div class="flex items-center space-x-2">
                                <svg class="w-5 h-5 text-purple-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span class="dropdown-label" data-default="Status">Status</span>
                            </div>
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div id="status-dropdown" class="dropdown hidden absolute top-full left-0 right-0 mt-1 bg-gray-800 border border-gray-600 rounded-lg shadow-xl z-10">
                            <div class="p-2 space-y-1">
                                {% for status in statuses %}
                                <label class="flex items-center space-x-2 p-2 hover:bg-gray-700 rounded cursor-pointer">
                                    <input type="radio" name="status" value="{{ status|lower }}" class="appearance-none text-purple-primary hover:text-500-gray">
                                    <span>{{ status }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <!-- Clear All Button -->
                    <div class="col-span-2 sm:col-span-1 flex flex-col gap-2 mt-2">
                      <button
                        type="button"
                        class="bg-gray-700 text-white py-2 rounded-lg hover:scale-105 transition-all duration-200"
                        onclick="clearFilters()">
                        Clear All
                      </button>
                    </div>

                    <!-- Search Button (Mobile Only) -->
                    <div class="col-span-2 sm:hidden flex flex-col gap-2 mt-2">
                      <button
                        type="submit"
                        class="py-2 font-semibold text-white rounded-lg transition-all duration-200 transform hover:scale-105 focus:ring-2 focus:ring-purple-primary focus:ring-offset-2 focus:ring-offset-gray-900 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700">
                        Search
                      </button>
                    </div>
                </div>
            </form>
        </div>

        <div class="hidden" id="search_title">{{ search_title }}</div>
        <!-- Results Summary -->
        {% if anime_list %}
        <div class="flex items-center justify-between mb-6">
            <div class="text-gray-400">
                <span>Showing <span id="anime-count">{{ anime_list|length }}</span> of {{ total_results }} results</span>
            </div>
            <div class="flex items-center space-x-2 text-sm text-gray-400">
                <span>Sort by:</span>
                <select class="bg-gray-800 border border-gray-600 rounded px-3 py-1 text-white focus:ring-2 focus:ring-purple-primary" id="sort-select">
                    <option value="popularity" {% if sort_by == 'popularity' %}selected{% endif %}>Popularity</option>
                    <option value="rating" {% if sort_by == 'rating' %}selected{% endif %}>Rating</option>
                    <option value="year" {% if sort_by == 'year' %}selected{% endif %}>Year</option>
                    <option value="title" {% if sort_by == 'title' %}selected{% endif %}>Title</option>
                </select>
            </div>
        </div>
        {% endif %}
        <div id="explore-state"
             data-search="{{ search_title }}"
             {% for name, value in active_filters %}
                 data-{{ name }}="{{ value }}"
             {% endfor %}
             class="hidden">

        </div>

        <!-- Anime Grid -->
        {% if anime_list %}
            <div class="anime-container grid grid-cols-2 sm:grid-cols- md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-4 gap-6" id="anime-container">
                {% for anime in anime_list %}
                <div class="anime-card group relative bg-gray-900 border border-gray-700 rounded-xl overflow-hidden hover:border-purple-primary transition-all duration-300 hover:shadow-lg hover:shadow-purple-primary/20 hover:transform hover:scale-105" data-mal-id="{{ anime.mal_id }}" onclick="HandleAnimeDetail({{ anime.mal_id }})">
                   <!-- Mobile Responsive Header with Status Badge and Action Buttons -->
                    <div class="absolute top-1.5 left-1.5 right-1.5 z-9 flex justify-between items-center md:top-3 md:left-3 md:right-3">
                        <!-- Status Badge -->
                        <div class="flex-shrink-0" data-status="{{ anime.status_color }}">
                            <span class="px-1.5 py-0.5 text-xs font-semibold text-white rounded-full {{ anime.status_color.class }} md:text-sm md:px-3 md:py-1">
                                {{ anime.status_color.label|title }}
                            </span>
                        </div>

                        <!-- Action Buttons (Heart and Plus) -->
                        <div class="flex space-x-1 md:space-x-2 flex-shrink-0">
                            <!-- Heart Button -->
                            <button class="cursor-pointer p-1 mt-[1px] bg-black bg-opacity-50 hover:bg-opacity-70 rounded-full md:p-2" id="fav-btn-{{ anime.mal_id }}" onclick="toggle_favorite({{ anime.mal_id }}, event)">
                                <svg class="w-3 h-3 md:w-4 md:h-4 {% if anime.is_favorite %}fill-pink-500 stroke-pink-500 {% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="fav-icon-{{ anime.mal_id }}">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" ></path>
                                </svg>
                            </button>

                            <!-- Plus Button -->
                        {% if anime.is_in_watchlist %}
                            <button class="cursor-pointer p-1 mt-[1px] bg-black bg-opacity-50 hover:bg-opacity-70 rounded-full md:p-2 text-green-500 " id="add-btn-{{ anime.mal_id }}" onclick="addToWatchlist({{ anime.mal_id }}, event)" data-is_fav="{{ anime.is_in_watchlist }}" >
                                <svg class="w-3 h-3 md:w-4 md:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="add-icon-{{ anime.mal_id }}">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </button>
                        {% else %}
                            <button class="text-white cursor-pointer p-1 mt-[1px] bg-black bg-opacity-50 hover:bg-opacity-70 rounded-full md:p-2 hover:text-green-500 " id="add-btn-{{ anime.mal_id }}" onclick="addToWatchlist({{ anime.mal_id }}, event)" data-is_fav="{{ anime.is_in_watchlist }}">
                                <svg class="w-3 h-3 md:w-4 md:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="add-icon-{{ anime.mal_id }}">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                            </button>
                        {% endif %}
                        </div>
                    </div>

                    <!-- Anime Poster -->
                    <div class="aspect-[3/4] relative overflow-hidden">
                        <img
                            src="{{ anime.images.webp.large_image_url }}"
                            alt="{{ anime.title_english }}"
                            class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300"
                            data-image="{{ anime.images.webp.large_image_url }}"
                        >
                    </div>

                    <!-- Anime Info -->
                    <div class="p-4" data-title="{{ anime.title_english }}">
                        <h3 class="font-semibold text-white text-sm line-clamp-2 group-hover:text-purple-primary transition-colors duration-200">
                            {{ anime.title_english }}
                        </h3>
                        {% if anime.aired.prop.from.year %}
                        <p class="text-xs text-gray-400 mt-1" data-year="{{ anime.aired.prop.from.year }}">{{ anime.aired.prop.from.year }}</p>
                        {% endif %}
                        {% if anime.score %}
                        <div class="flex items-center mt-2" data-score="{{ anime.score }}">
                            <svg class="w-4 h-4 text-yellow-400 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                            </svg>
                            <span class="text-xs text-gray-400">{{ anime.score }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
        <!-- Empty State -->
        <div class="text-center py-16">
            <div class="bg-gray-900 border border-gray-700 rounded-xl p-12">
                <div class="w-20 h-20 bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
                <h3 class="text-2xl font-semibold text-gray-300 mb-3">No anime found</h3>
                <p class="text-gray-400 mb-6 max-w-md mx-auto">
                    Try adjusting your search terms or filters to find what you're looking for.
                </p>
                <button
                    class="px-6 py-3 font-semibold text-white rounded-lg transition-all duration-200"
                    style="background-color: #7c3aed;">
                    Clear Filters
                </button>
            </div>
        </div>
        {% endif %}
        <input type="#" id="has_next" value="{{ has_next_page }}" class="hidden">
        <input type="#" id="next_api" value="{{ next_api_page }}" class="hidden">
        <!--Load more button-->
        {% if has_next_page %}
        <div class="flex justify-center mt-8">
          <button
            id="load-more-btn"
            class="px-6 py-3 sm:w-48 bg-purple-600 text-white rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-400 transition duration-200"
          >
            Load More
          </button>
        </div>
        {% endif %}
</div>
{% endblock %}
{% block scripts %}
    <script>

        let navigatingToDetail = false;

        window.HandleAnimeDetail = function(malId) {
            navigatingToDetail = true;
            // Save current HTML
            const container = document.getElementById("anime-container");
            sessionStorage.setItem("explore_anime_html", container.innerHTML);

            // Save input values
            sessionStorage.setItem("next_api", document.getElementById("next_api").value);
            sessionStorage.setItem("has_next", document.getElementById("has_next").value);

            // Save scroll bar position
            sessionStorage.setItem("explore_scroll", window.scrollY);

            // Save displayedAnimeIds set
            sessionStorage.setItem("displayed_ids", JSON.stringify(Array.from(displayedAnimeIds)));

            goToAnimeDetails(malId);
        }

        const displayedAnimeIds = new Set();

        function changeValue(new_next, new_next_page){
            let has_next = document.getElementById("has_next");
            let next_page = document.getElementById("next_api");
            //Updating the new values
            has_next.value = new_next;
            next_page.value = new_next_page;
        }

        function updateAnimeCount() {
            const countDisplay = document.getElementById("anime-count");
            const animeCards = document.querySelectorAll(".anime-card");
            countDisplay.textContent = animeCards.length;
        }

        function addAnime(anime_list){
          const animeContainer = document.getElementById("anime-container");
          const animeHTML = anime_list
          .filter(anime => {
              // Only keep anime not already displayed
              if (displayedAnimeIds.has(anime.mal_id)) {
                return false;
              }
              displayedAnimeIds.add(anime.mal_id); // Mark as shown
              return true;
          })
          .map(anime => {
          const mal_id = anime.mal_id;
          const title = anime.title_english || anime.title || 'Untitled';
          const score = anime.score || 'N/A';
          const year = anime.year || '';
          const image = anime.image || anime.images?.webp?.large_image_url || 'fallback.jpg';
          const status = anime.status_color?.label || '';
          const statusClass = anime.status_color?.class || 'bg-gray-600';
          const isFavorite = anime.is_favorite;
          const isInWatchlist = anime.is_in_watchlist;
            return `
            <div class="anime-card group relative bg-gray-900 border border-gray-700 rounded-xl overflow-hidden hover:border-purple-primary transition-all duration-300 hover:shadow-lg hover:shadow-purple-primary/20 hover:transform hover:scale-105" data-mal-id="${mal_id}" onclick="HandleAnimeDetail(${mal_id})">
              <div class="absolute top-1.5 left-1.5 right-1.5 z-9 flex justify-between items-center md:top-3 md:left-3 md:right-3">
                <div class="flex-shrink-0" data-status="${status}">
                  <span class="px-1.5 py-0.5 text-xs font-semibold text-white rounded-full ${statusClass} md:text-sm md:px-3 md:py-1">
                    ${status.charAt(0).toUpperCase() + status.slice(1)}
                  </span>
                </div>
                <div class="flex space-x-1 md:space-x-2 flex-shrink-0">
                  <button class="cursor-pointer p-1 mt-[1px] bg-black bg-opacity-50 hover:bg-opacity-70 rounded-full md:p-2" id="fav-btn-${mal_id}" onclick="toggle_favorite(${mal_id}, event)">
                    <svg class="w-3 h-3 md:w-4 md:h-4 ${isFavorite ? 'fill-pink-500 stroke-pink-500' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24" id="fav-icon-${mal_id}">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                    </svg>
                  </button>
                  <button class="cursor-pointer p-1 mt-[1px] bg-black bg-opacity-50 hover:bg-opacity-70 rounded-full md:p-2 ${isInWatchlist ? 'text-green-500' : 'text-white hover:text-green-500'}" id="add-btn-${mal_id}" onclick="addToWatchlist(${mal_id}, event)" data-is_fav="${isInWatchlist}">
                    <svg class="w-3 h-3 md:w-4 md:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" id="add-icon-${mal_id}">
                      ${isInWatchlist
                        ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>'
                        : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>'}
                    </svg>
                  </button>
                </div>
              </div>

              <div class="aspect-[3/4] relative overflow-hidden">
                <img src="${image}" alt="${title}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300" />
              </div>

              <div class="p-4">
                <h3 class="font-semibold text-white text-sm line-clamp-2 group-hover:text-purple-primary transition-colors duration-200">${title}</h3>
                ${year ? `<p class="text-xs text-gray-400 mt-1">${year}</p>` : ''}
                ${score !== 'N/A' ? `
                  <div class="flex items-center mt-2">
                    <svg class="w-4 h-4 text-yellow-400 mr-1" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                    </svg>
                    <span class="text-xs text-gray-400">${score}</span>
                  </div>` : ''}
              </div>
            </div>
            `;
          }).join('');

          animeContainer.insertAdjacentHTML("beforeend", animeHTML);
          updateAnimeCount()

        }

        document.getElementById("sort-select").addEventListener("change", function () {
            const selectedSort = this.value;

            // Get current filters from explore-state div (assuming it's still used)
            const stateDiv = document.getElementById("explore-state");

            const search = stateDiv?.dataset.search || '';
            const genre = stateDiv?.dataset.genre || '';
            const year = stateDiv?.dataset.year || '';
            const rating = stateDiv?.dataset.rating || '';
            const status = stateDiv?.dataset.status || '';

            // Build new URL with all filters + sort
            const params = new URLSearchParams();
            if (search) params.append("search", search);
            if (genre) params.append("genre", genre);
            if (year) params.append("year", year);
            if (rating) params.append("rating", rating);
            if (status) params.append("status", status);
            if (selectedSort) params.append("sort", selectedSort);

            window.location.href = `?${params.toString()}`;
        });

        function fetchMoreAnime(page_no) {
            const stateDiv = document.getElementById("explore-state");

            const search = stateDiv?.dataset.search || '';
            const genre = stateDiv?.dataset.genre || '';
            const year = stateDiv?.dataset.year || '';
            const rating = stateDiv?.dataset.rating || '';
            const status = stateDiv?.dataset.status || '';

            // ðŸ‘‡ Get current sort value from dropdown
            const sort = document.getElementById("sort-select")?.value || '';

            const queryParams = new URLSearchParams();
            queryParams.append("page", page_no);
            if (search) queryParams.append("search", search);
            if (genre) queryParams.append("genre", genre);
            if (year) queryParams.append("year", year);
            if (rating) queryParams.append("rating", rating);
            if (status) queryParams.append("status", status);
            if (sort) queryParams.append("sort", sort);  // ðŸ‘ˆ Include sort

            return fetch(`fetch-more-anime?${queryParams.toString()}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(data);
                    changeValue(data.has_next, data.next_api_page);
                    addAnime(data.anime);

                    const has_next = document.getElementById("has_next");
                    if (has_next.value === "false") {
                        loadMoreBtn.classList.add("hidden");
                    }
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                });
        }


        const loadMoreBtn = document.getElementById('load-more-btn');
        if (loadMoreBtn) {
            loadMoreBtn.addEventListener('click', () => {
                  // Show loading state immediately
                  loadMoreBtn.disabled = true;
                  loadMoreBtn.textContent = 'Loading...';
                  loadMoreBtn.classList.add('opacity-50', 'cursor-not-allowed');

                  let next_page = document.getElementById("next_api");
                  fetchMoreAnime(next_page.value)
                    .finally(() => {
                      // Reset button state
                      loadMoreBtn.disabled = false;
                      loadMoreBtn.textContent = 'Load More';
                      loadMoreBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    });
            });
        }

        document.addEventListener("DOMContentLoaded", () => {
            const savedHTML = sessionStorage.getItem("explore_anime_html");
            const savedNext = sessionStorage.getItem("next_api");
            const savedHasNext = sessionStorage.getItem("has_next");
            const savedIds = sessionStorage.getItem("displayed_ids");
            const scrollY = sessionStorage.getItem("explore_scroll");

            // Hide Load More if session says no more data
            if (savedHasNext === "false" && loadMoreBtn) {
                loadMoreBtn.classList.add("hidden");
            }

            if (savedHTML && savedHasNext && savedIds) {
                document.getElementById("anime-container").innerHTML = savedHTML;
                document.getElementById("next_api").value = savedNext;
                document.getElementById("has_next").value = savedHasNext;
                window.scrollTo(0, parseInt(scrollY));
                updateAnimeCount()

                const idsArray = JSON.parse(savedIds);
                idsArray.forEach(id => displayedAnimeIds.add(id));
            }
        });


        window.addEventListener("beforeunload", () => {
            // Clear only if reloading (not navigating to detail)
            if (!navigatingToDetail) {
                sessionStorage.removeItem("explore_anime_html");
                sessionStorage.removeItem("next_api");
                sessionStorage.removeItem("has_next");
                sessionStorage.removeItem("displayed_ids");
                sessionStorage.removeItem("explore_scroll");
            }
        });
    </script>
{% endblock %}